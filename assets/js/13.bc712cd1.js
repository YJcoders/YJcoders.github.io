(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{425:function(s,a,t){s.exports=t.p+"assets/img/HotModuleRepalcement.b3721c84.png"},426:function(s,a,t){s.exports=t.p+"assets/img/Hot.ad3d97c9.png"},525:function(s,a,t){"use strict";t.r(a);var e=t(1),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h3",{attrs:{id:"热更新源码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#热更新源码"}},[s._v("#")]),s._v(" 热更新源码")]),s._v(" "),a("p",[a("img",{attrs:{src:t(425),alt:"热更新源码"}})]),s._v(" "),a("h3",{attrs:{id:"热更新简易过程图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#热更新简易过程图"}},[s._v("#")]),s._v(" 热更新简易过程图")]),s._v(" "),a("p",[a("img",{attrs:{src:t(426),alt:"热更新简易过程"}})]),s._v(" "),a("h3",{attrs:{id:"热更新简易描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#热更新简易描述"}},[s._v("#")]),s._v(" 热更新简易描述")]),s._v(" "),a("div",{staticClass:"language-md line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-md"}},[a("code",[s._v("1、启动服务，进入 webpack-dev-server，向入口添加两个文件\nwebpack-dev-server/client/index.js\n监听 hash 事件，通知浏览器更新，触发 WebpackHotUpdate webpack/hot/dev-server.js\n监听 WebpackHotUpdate 事件，通过 HotmoduleRelacementPlugin.js 的\nhotcheck 方法，发出更新请求，进行更新\n2、注册 HotmoduleRelacementPlugin\n热更新插件 diff 此次与上次的代码，处理生成最新代码并 emit 出去\n3、通过 express 创建 server，提供本地静态资源服务\n创建 webSocket，建立本地与浏览器的双向通信服务\n4、注册插件 webpack-dev-middleware\n插件 监听 webpack 构建完成，将编译的文件写入内存\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h3",{attrs:{id:"热更新过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#热更新过程"}},[s._v("#")]),s._v(" 热更新过程")]),s._v(" "),a("p",[s._v("HMR 的一个完整周期，分为两部分：启动阶段和文件监控更新流程")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 启动阶段：\nWebpack 和 webpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server 进行交互。主要是通过 Express 的中间件 webpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("middleware进行交互\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.")]),s._v(" webpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server 启动 Webpack 打包的 watch 模式，Webpack 会监听文件的变化，一旦有文件发生变化，则会重新进行打包，\nwatch 模式下 Webpack 打包的结果不会保存到硬盘上；\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.")]),s._v(" webpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server 通过 webpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("middleware 与 Webpack 进行交互，Webpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("middleware 初始化\n会接收 Webpack 的 Compiler 对象，通过 Compiler 的钩子可以监听 Webpack 的打包过程；\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.")]),s._v(" 如果 devServer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("watchContentBase"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v(" ，则 webpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server 监听文件夹中静态文件的变化，\n发生变化则 通知浏览器刷新页面重新请求新的文件；\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.")]),s._v(" 打开浏览器之后，webpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server 会利用 sockjs 在浏览器和 Server 之间创建一个 WebSocket 长连接，\n它们之间的通信内容主要是传递编译模块的文件信息 （hash 值），这时候如果 Webpack 监控的文件发生了修改，\nwebpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("hot"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server 来实现 "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("HMR")]),s._v(" 更新还是刷 新页面。\n\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 文件监控更新流程：\n当 Webpack 监控的依赖图中的某个文件修改之后：\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.")]),s._v(" Webpack 会重新编译文件，这时候我们在 webpack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("js 中添加的插件 HotModuleReplacementPlugin\n  会生成两次编译之间差异文件列表（manifest）文件 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("hot"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("update"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("json ，\n  这个 manifest "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("JSON")]),s._v(" 文件包含了变化文件的 Update 内容，即 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("hot"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("update"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("js 。\n  webpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server 中的 webpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("middleware 会通 过 Webpack 的 Compiler 钩子监听打包进程，\n  然后通知 webpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server 使用 WebSocket 长连接推送编译之后的 hash 值；\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.")]),s._v(" 除了发送编译后 Hash 值之外，webpack"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("dev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server 还会通过长连接告诉浏览器当前的页面代码是"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("**")]),s._v(" invalid "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("**")]),s._v(" 状态的，需要更新新的代码\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.")]),s._v(" 浏览器拿到 Hash 之后，会首先发起一个 Ajax 请求 manifest 文件 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("hot"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("update"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("json 文件内容；\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.")]),s._v(" manifest 列表文件内容拿到之后，会告诉 "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("HMR")]),s._v(" 的 Runtime 请求那些变化的 JavaScript 文件，这时候会 Runtime 会按照清单列表发起 "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("JSONP")]),s._v(" 请求，\n将两次编译的差异文件 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("hot"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("update"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("js 获取下来，插到页面 head 标签的 script 中执行，最终完成了更新的全流程。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);